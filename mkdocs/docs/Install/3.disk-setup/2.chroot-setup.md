# Chroot Setup

## Mounting the Partitions

Next we're going to mount the newly created partitions

```bash
# Mount the root parittion
mkdir -p /mnt/gentoo
mount /dev/nvme0n1p3 /mnt/gentoo

# Enable the swap
swapon /dev/nvme0n1p2

# Mount the efi partition
mkdir -p /mnt/gentoo/efi
mount /dev/nvme0n1p1 /mnt/gentoo/efi
```

## Setting up the Stage3 Image

Next we need to check the clock is set correctly for https downloads
```bash
# Show Date Time
date
# Resync if needed
chronyd -q
```

Time to download a stage3, the available images can be seen here
In this case I'm going for a amd64, systemd, desktop stage3 image

  * https://www.gentoo.org/downloads/

```bash
cd /mnt/gentoo
# Download the stage3
wget https://distfiles.gentoo.org/releases/amd64/autobuilds/20250216T164837Z/stage3-amd64-desktop-systemd-20250216T164837Z.tar.xz
# Extract the stage3
tar xpvf stage3-*.tar.xz --xattrs-include='*.*' --numeric-owner -C /mnt/gentoo
# Cleanup
rm stage3-*.tar.xz
```


## Make.conf

Historically we needed to set the make options within make.conf for using multiple cores of the processor when compiling
But with newer versions of portage this is handled automatically without the need to specify it

Since I'll be using binary packages leter on, I tend to leave this largely unchanged at this stage.


## Entering chroot

Lets copy across resolve.conf for when we enter into the chroot
```bash
cp --dereference /etc/resolv.conf /mnt/gentoo/etc/
```

Next lets bind some of the proc and other directories into the new root
```bash
mount --types proc /proc /mnt/gentoo/proc
mount --rbind /sys /mnt/gentoo/sys
mount --make-rslave /mnt/gentoo/sys
mount --rbind /dev /mnt/gentoo/dev
mount --make-rslave /mnt/gentoo/dev
mount --bind /run /mnt/gentoo/run
mount --make-slave /mnt/gentoo/run
```

Finally enter into the chroot
```bash
chroot /mnt/gentoo /bin/bash
source /etc/profile
export PS1="(chroot) ${PS1}"
```


## Root Setup

Now that we're inside the chroot lets perform some initial tasks to get things setup
```bash
emerge-webrsync
emerge --ask --verbose --oneshot app-portage/mirrorselect
mirrorselect -i -o >> /etc/portage/make.conf
# Select a mirror in the local country
emerge --sync
```

## Switching Profile

For this example I'll be switching across to the systemd / Plasma (Kde) Profile

```bash
# To list the available profiles
eselect profile list
# To set a new profile
eselect profile set 28
```

## Setting up binaary host packages

Ideally we don't want to compile everything unless we have to.
Most packages can now just be downloaded and installed without the need for compilation.
The idea being to only compile for those packages that are out of the ordinary.

With a new setup the configuration file `/etc/portage/binrepos.conf/gentoobinhost.conf` should already be present

```bash
# First edit make.conf
nano /etc/portage/make.conf
# Add the following line to the bottom / add in to the features
FEATURES="${FEATURES} getbinpkg"
# Next generate the GPG Keys needed locally
getuto
```

# Updates / Installs

Next lets perform a world update
```bash
# Show what packages will be updated
emerge -up --deep --changed-use @world
# Perform the actucal update
emerge -u --deep --changed-use @world
```

Lets perform a depclean to clear out anything not needed anymore
```bash
# Show what will be removed
emerge -p --depclean
# Perform the actuial removal
emerge --depclean
```




## Setting up the Use variable

TODO

```bash
emerge --info | grep ^USE
```

## TODO

  * Grub / Bootloader
